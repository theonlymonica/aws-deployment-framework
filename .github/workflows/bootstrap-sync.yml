name: Bootstrap Repository Sync

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  BOOTSTRAP_BUCKET: ${{ secrets.BOOTSTRAP_BUCKET }}
  BOOTSTRAP_KEY: ${{ secrets.BOOTSTRAP_KEY }}
  BOOTSTRAP_PIPELINE_NAME: ${{ secrets.BOOTSTRAP_PIPELINE_NAME }}

jobs:
  package-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure dependencies
        run: sudo apt-get update && sudo apt-get install -y zip rsync

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build bootstrap archive
        run: |
          set -euo pipefail
          TMP_DIR=$(mktemp -d)
          rsync -a --delete src/lambda_codebase/initial_commit/bootstrap_repository/ "$TMP_DIR"/
          (cd "$TMP_DIR" && zip -rq "$GITHUB_WORKSPACE/bootstrap_repository.zip" .)
          rm -rf "$TMP_DIR"

      - name: Upload archive to S3
        run: |
          if [ -z "$BOOTSTRAP_BUCKET" ] || [ -z "$BOOTSTRAP_KEY" ]; then
            echo "BOOTSTRAP_BUCKET and BOOTSTRAP_KEY secrets must be set" >&2
            exit 1
          fi
          aws s3 cp bootstrap_repository.zip "s3://$BOOTSTRAP_BUCKET/$BOOTSTRAP_KEY"

      - name: Trigger bootstrap pipeline (optional)
        if: env.BOOTSTRAP_PIPELINE_NAME != ''
        run: |
          aws codepipeline start-pipeline-execution \
            --name "$BOOTSTRAP_PIPELINE_NAME" \
            >/dev/null
